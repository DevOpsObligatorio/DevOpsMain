name: CI - Build & Push Backend to ECR

on:
  push:
    branches: 
      - "main"
      - "dev"
      - "test"
  workflow_dispatch:

jobs:
  build-test-and-push:
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ github.ref_name }}   # main | dev | test
      IMAGE_TAG: ${{ github.ref_name }}     # main | dev | test

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      # -------------------------
      # CLONAR REPOSITORIOS
      # -------------------------
      - name: Clonar Product Service
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/DevOpsObligatorio/DevOpsProduct-Service.git product-service

      - name: Clonar Inventory Service
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/DevOpsObligatorio/DevOps-Inventory-Service.git inventory-service

      # -------------------------
      # Instalar Newman
      # -------------------------
      - name: Install Newman
        run: npm install -g newman

      # -------------------------
      # Docker Compose para Tests
      # -------------------------
      - name: Docker Compose Up (Tests Environment)
        run: docker compose -f docker-compose.ci.yml up -d --build

      # -------------------------
      # Esperar Product Service
      # -------------------------
      - name: Esperar Product Service
        run: |
          for i in {1..20}; do
            if curl -s http://localhost:8001/health | grep -q "healthy"; then
              echo "Product OK"; exit 0
            fi
            echo "waiting product..."; sleep 5
          done
          exit 1

      - name: Esperar Inventory Service
        run: |
          for i in {1..20}; do
            if curl -s http://localhost:8002/health | grep -q "healthy"; then
              echo "Inventory OK"; exit 0
            fi
            echo "waiting inventory..."; sleep 5
          done
          exit 1

      # -------------------------
      # Tests Postman
      # -------------------------
      - name: Run Synced Backend Tests
        run: |
          newman run backend-tests-postman.json

      # -------------------------
      # AWS Login
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ================================================================
      # PRODUCT SERVICE
      # ================================================================

      - name: Build Product Service image
        run: docker build -t product-service ./product-service

      - name: Tag Product Service image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: product-service-${{ env.ENVIRONMENT }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: docker tag product-service:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Push Product Service image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: product-service-${{ env.ENVIRONMENT }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # ================================================================
      # INVENTORY SERVICE
      # ================================================================

      - name: Build Inventory Service image
        run: docker build -t inventory-service ./inventory-service

      - name: Tag Inventory Service image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: inventory-service-${{ env.ENVIRONMENT }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: docker tag inventory-service:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Push Inventory Service image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: inventory-service-${{ env.ENVIRONMENT }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG


