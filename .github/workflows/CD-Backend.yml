name: CD - Deploy backend to EKS

on:
  workflow_run:
    workflows: ["CI - Build & Push Backend to ECR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      ENVIRONMENT: ${{ github.event.workflow_run.head_branch }}  # main | dev | test
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -----------------------------
      # SET CLUSTER NAME Y LAMBDA
      # -----------------------------
      - name: Definir nombres dinÃ¡micos
        id: names
        run: |
          echo "cluster_name=${ENVIRONMENT}-eks-cluster" >> $GITHUB_OUTPUT
          echo "lambda_name=pipeline-notify-${ENVIRONMENT}" >> $GITHUB_OUTPUT

      # -----------------------------
      # KUBECONFIG
      # -----------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name ${{ steps.names.outputs.cluster_name }}

      - name: Create namespace if not exists
        run: |
          kubectl get ns microservices || kubectl create ns microservices

      # -----------------------------
      # REEMPLAZAR VARIABLES EN MANIFESTS
      # -----------------------------
      - name: Reemplazar variables en manifests
        env:
          AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT}}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          find k8s -type f -name "*.yaml" -print0 | while IFS= read -r -d '' file; do
            sed -i "s|\${AWS_ACCOUNT}|${AWS_ACCOUNT}|g" "$file"
            sed -i "s|\${ENVIRONMENT}|${ENVIRONMENT}|g" "$file"
          done

      # -----------------------------
      # APPLY MANIFESTS
      # -----------------------------
      - name: Apply manifests
        run: |
          kubectl apply -n microservices -f k8s/redis
          kubectl apply -n microservices -f k8s/postgres
          kubectl apply -n microservices -f k8s/inventory-service
          kubectl apply -n microservices -f k8s/product-service

      # -----------------------------
      # LAMBDA NOTIFICATION
      # -----------------------------
      - name: Notificar Lambda
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          aws lambda invoke \
            --function-name ${{ steps.names.outputs.lambda_name }} \
            --invocation-type RequestResponse \
            --payload "{\"message\":\"Pipeline finalizado con exito en ${ENVIRONMENT}\"}" \
            --cli-binary-format raw-in-base64-out \
            response.json
